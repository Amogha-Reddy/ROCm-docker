# Build this dockerfile with `docker build -f roct-thunk-dockerfile -t roc/roct .`

# To reduce container rebuild time, place commands least likely to change at top to
# most changing at bottom

# This builds the radeon open compute kernel thunk

# ubuntu:14.04.3, the native kernel is '3.19'
FROM roc/rock
MAINTAINER Kent Knox <kent.knox@amd>

# Constant environment variables
ENV WORKPATH /root
ENV HSATHK_SRC_PATH /usr/local/src/ROCT-Thunk-Interface
ENV HSATHK_INSTALL_PATH /usr/lib/x86_64-linux-gnu

# Set working directory to be root's home directory
WORKDIR ${WORKPATH}

# Default to a login shell
ENTRYPOINT ["/bin/bash"]
CMD ["-l"]

# Initialize the image we are working with
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
  build-essential \
  git && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/*

RUN cd /usr/local/src && \
  git clone --depth=1 https://github.com/RadeonOpenCompute/ROCT-Thunk-Interface.git && \
  cd ${HSATHK_SRC_PATH} && \
  make -j $(nproc) all deb && \
  rm -f ${HSATHK_INSTALL_PATH}/libhsakmt.* && \
  cp build/lnx64a/lib*.so.1 ${HSATHK_INSTALL_PATH} && \
  ln -s ${HSATHK_INSTALL_PATH}/libhsakmt.so.1 ${HSATHK_INSTALL_PATH}/libhsakmt.so && \
  rm -rf build && \
  ldconfig
