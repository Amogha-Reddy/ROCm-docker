# Build this dockerfile with `docker build -f rocr-dockerfile -t roc/rocr .`

# To reduce container rebuild time, place commands least likely to change at top to
# most changing at bottom

# This builds the radeon open compute runtime

# This kfd has only been tested so far on linux-headers-generic-lts-vivid
# ubuntu:14.04.3, the native kernel is '3.19'
FROM ubuntu:14.04.3
MAINTAINER Kent Knox <kent.knox@amd>

# Constant environment variables
ENV WORKPATH /root
ENV ROCR_INSTALL_PATH /opt/hsa

ENV LD_LIBRARY_PATH ${ROCR_INSTALL_PATH}/lib

# Set working directory to be root's home directory
WORKDIR ${WORKPATH}

# Default to a login shell
ENTRYPOINT ["/bin/bash"]
CMD ["-l"]

# Initialize the image we are working with
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
  build-essential \
  libc6-dev-i386 \
  libelf-dev \
  git \
  cmake && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/*

# Build can't find hsakmt.h yet, possibly located in ROCK
#RUN cd /usr/local/src && \
#    git clone https://github.com/RadeonOpenCompute/ROCR-Runtime.git && \
#    mkdir -p ROCR-Runtime/build && \
#    cd ROCR-Runtime/build && \
#    cmake \
#      -DCMAKE_INSTALL_PREFIX=${ROCR_INSTALL_PATH} \
#      -DCMAKE_BUILD_TYPE=Release \
#      ../src && \
#    make -j `nproc` install && \
#    cd .. && rm -rf build

RUN cd /usr/local/src && \
  git clone https://github.com/RadeonOpenCompute/ROCR-Runtime.git && \
  cd ROCR-Runtime/packages/ubuntu && \
  dpkg -i *.deb

# The runtime has a dependency on a library from the kfd; needs to be copied into
# the same directory as the dockerfile
COPY libhsakmt.so.1 /opt/hsa/lib
