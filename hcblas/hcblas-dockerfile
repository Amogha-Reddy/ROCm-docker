# Build this dockerfile with `docker build -f hcblas-dockerfile -t hcblas:master .`

# To reduce container rebuild time, place commands least likely to change at top to
# most changing at bottom

# This kfd has only been tested so far on linux-headers-generic-lts-vivid
# ubuntu:14.04.3, the native kernel is '3.19'
FROM hcc:master
MAINTAINER Kent Knox <kent.knox@amd>

# Constant environment variables
ENV WORKPATH /root
ENV HCBLAS_INSTALL_PATH /usr/local

# Set working directory to be root's home directory
WORKDIR ${WORKPATH}

# Default to a login shell
ENTRYPOINT ["/bin/bash"]
CMD ["-l"]

# Initialize the image we are working with
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
  build-essential \
  git \
  cmake && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/*

RUN cd /usr/local/src && \
  git clone https://bitbucket.org/multicoreware/hcblas.git && \
  mkdir -p hcblas/build && \
  cd hcblas/build && \
  cmake \
    -DCMAKE_INSTALL_PREFIX=${HCBLAS_INSTALL_PATH} \
    -DCMAKE_C_COMPILER=${HCC_INSTALL_PATH}/bin/clang \
    -DCMAKE_CXX_COMPILER=${HCC_INSTALL_PATH}/bin/clang++ \
    -DCMAKE_CXX_FLAGS="-fPIC" \
    .. && \
    make -j `nproc` install && \
    cd .. && rm -rf build
